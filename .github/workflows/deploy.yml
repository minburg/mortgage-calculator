name: Deploy Protected Stlite App

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (for Staticrypt)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Staticrypt
        run: npm install -g staticrypt

      - name: Create index.html (stlite)
        run: |
          # Pfad zu deiner Datei: src/mortgage-calculator-app.py
          cat <<EOF > temp.html
          <!DOCTYPE html>
          <html>
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
              <title>Finanz-Rechner</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.63.1/build/stlite.css" />
              <style>
                /* Ein kleiner Hack, um das "Laden"-Gefühl zu verbessern */
                body { background-color: #0e1117; } 
              </style>
            </head>
            <body>
              <div id="root"></div>
              <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.63.1/build/stlite.js"></script>
              <script>
                stlite.mount({
                  requirements: ["pandas", "altair"],
                  entrypoint: "mortgage-calculator-app.py",
                  files: {
                    "mortgage-calculator-app.py": \`$(cat src/mortgage-calculator-app.py | sed 's/`/\\`/g')\`
                  }
                }, document.getElementById("root"));
              </script>
            </body>
          </html>
          EOF

      - name: Encrypt with Staticrypt
        env:
          Passwort_Safe: ${{ secrets.APP_PASSWORD }}
        run: |
          # 1. Aufräumen (falls Reste von vorherigen Runs da sind)
          rm -rf encrypted deploy temp.html
          
          # 2. temp.html neu erstellen (zur Sicherheit, falls vorher gelöscht)
          # Hier nutzen wir kurz den vorherigen Step-Code, 
          # aber eigentlich sollte temp.html aus dem vorherigen Step noch da sein.
          # Wir prüfen einfach nur, ob sie da ist:
          if [ ! -f temp.html ]; then
             echo "::error::temp.html fehlt! Bitte prüfen, ob der Step 'Create index.html' geklappt hat."
             exit 1
          fi
          
          # 3. Staticrypt ausführen (OHNE -o, einfach Standard)
          # Das erstellt den Ordner 'encrypted/' und legt dort 'temp.html' rein
          npx staticrypt temp.html -p "$Passwort_Safe"
          
          # 4. Debugging: Zeig uns, was erstellt wurde
          echo "Inhalt des Verzeichnisses nach Encryption:"
          ls -R
          
          # 5. Verschieben und Umbenennen
          # Wir erwarten die Datei in encrypted/temp.html
          if [ -f encrypted/temp.html ]; then
            mkdir -p deploy
            mv encrypted/temp.html deploy/index.html
            echo "✅ Erfolg: Datei wurde nach deploy/index.html verschoben."
          else
            echo "❌ FEHLER: Die Datei encrypted/temp.html wurde nicht gefunden."
            exit 1
          fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy
          branch: gh-pages
          clean: true
